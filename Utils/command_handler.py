# Utils/command_handler.py
"""–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–≤–æ–¥ (–∫–ª–∞–≤–∏—à–∏) –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∏–≥–Ω–∞–ª—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∏–≥—Ä—ã.
"""
import curses
from typing import List, Union
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º Player –Ω–∞–ø—Ä—è–º—É—é, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è—Ö —Ç–∏–ø–æ–≤
from Characters.player_classes import Player
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º battle_logger –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
from Battle.battle_logger import battle_logger
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º battle_simulator –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—è
from Battle.battle_simulator import BattleSimulator
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º inventory –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–º
from Inventory.inventory import get_inventory

# === –ö–û–ù–°–¢–ê–ù–¢–´ –î–õ–Ø –°–ò–ì–ù–ê–õ–û–í ===
# –≠—Ç–∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥
CMD_ACTION_NONE: str = "none"
CMD_ACTION_EXIT: str = "exit"
CMD_ACTION_START_BATTLE: str = "start_battle"
CMD_ACTION_OPEN_INVENTORY: str = "open_inventory"
CMD_ACTION_OPEN_SKILLS: str = "open_skills"
CMD_ACTION_OPEN_SHOP: str = "open_shop" # –î–æ–±–∞–≤–ª–µ–Ω —Å–∏–≥–Ω–∞–ª –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–∞
CMD_ACTION_SHOW_STATS: str = "open_stats" # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
CMD_ACTION_SHOW_HELP: str = "show_help"
CMD_ACTION_CLEAR_LOG: str = "clear_log"

# –¢–∏–ø –¥–ª—è –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è process_input
# –ú–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å–∏–≥–Ω–∞–ª (—Å—Ç—Ä–æ–∫—É) –∏–ª–∏ True/False (–±—É–ª–µ–≤–æ) –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
CommandResult = Union[str, bool]

class CommandHandler:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥. –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å GameContext/GameState.
    –í–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –æ–∫–æ–Ω, —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∏–≥–Ω–∞–ª—ã –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö.
    """
    def __init__(self, players: List[Player], enemies: List, stdscr: curses.window) -> None:
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥.
        Args:
            players: –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤.
            enemies: –°–ø–∏—Å–æ–∫ –≤—Ä–∞–≥–æ–≤.
            stdscr: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ–∫–Ω–æ curses.
        """
        self.players: List[Player] = players
        self.enemies: List = enemies # TODO: –£—Ç–æ—á–Ω–∏—Ç—å —Ç–∏–ø enemies, –µ—Å–ª–∏ —Å—Ç–∞–Ω–µ—Ç –∏–∑–≤–µ—Å—Ç–µ–Ω
        self.stdscr: curses.window = stdscr
        # –£–±–∏—Ä–∞–µ–º –ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∑–∞–ø—É—Å–∫ –æ–∫–æ–Ω –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏–π
        # self.commands = {...} - —ç—Ç–æ—Ç —Å–ª–æ–≤–∞—Ä—å –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω –¥–ª—è –ø—Ä—è–º–æ–≥–æ –º–∞–ø–ø–∏–Ω–≥–∞ –∫–æ–º–∞–Ω–¥

    def process_input(self, key: int) -> str:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - —Ç–µ–ø–µ—Ä—å —á–µ—Ä–µ–∑ –æ–¥–∏–Ω–æ—á–Ω—ã–µ –∫–ª–∞–≤–∏—à–∏.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∏–≥–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏—è, –∫–æ—Ç–æ—Ä—ã–π –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç—Å—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏.
        """
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–∏–Ω–æ—á–Ω—ã—Ö –∫–ª–∞–≤–∏—à
        if key == ord('\n'): # Enter
            return self.start_battle() # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∏–≥–Ω–∞–ª
        elif key in [ord('i'), ord('I')]:
            return self.open_inventory() # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∏–≥–Ω–∞–ª
        elif key in [ord('s'), ord('S')]:
            return self.open_skills() # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∏–≥–Ω–∞–ª
        elif key in [ord('r'), ord('R')]:
             return self.open_shop() # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∏–≥–Ω–∞–ª
        elif key == curses.KEY_F12: # F12
            return self.open_statistics() # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∏–≥–Ω–∞–ª
        elif key in [ord('h'), ord('H')]:
            self.show_help() # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–º–æ—â—å –Ω–∞–ø—Ä—è–º—É—é
            return CMD_ACTION_NONE # –ù–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥–∞
        elif key in [ord('c'), ord('C')]:
            self.clear_log() # –û—á–∏—â–∞–µ–º –ª–æ–≥ –Ω–∞–ø—Ä—è–º—É—é
            return CMD_ACTION_NONE # –ù–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥–∞
        elif key in [ord('q'), ord('Q'), 27]: # ESC
            return self.exit_game() # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∏–≥–Ω–∞–ª –≤—ã—Ö–æ–¥–∞
        else:
            # –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞
            return CMD_ACTION_NONE # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º

    # - –ú–µ—Ç–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –±–æ–ª—å—à–µ –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç –æ–∫–Ω–∞ –Ω–∞–ø—Ä—è–º—É—é -
    def start_battle(self) -> str:
        """–°–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –Ω–∞—á–∞—Ç—å –±–æ–π."""
        # –í—Å—è –ª–æ–≥–∏–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—è —Ç–µ–ø–µ—Ä—å –≤ EventState
        # –ó–¥–µ—Å—å –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∏–≥–Ω–∞–ª
        battle_logger.log_system_message("‚öîÔ∏è –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –±–æ—é...")
        # TODO: –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –±–æ—é, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        return CMD_ACTION_START_BATTLE

    def show_help(self) -> None:
        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–º–æ—â—å."""
        # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–º–æ—â—å –Ω–∞–ø—Ä—è–º—É—é –≤ —Ç–µ–∫—É—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
        battle_logger.log_system_message("‚ÑπÔ∏è –ü–æ–º–æ—â—å: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–ª–∞–≤–∏—à–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.")

    def clear_log(self) -> None:
        """–û—á–∏—â–∞–µ—Ç –ª–æ–≥."""
        battle_logger.clear_log()
        battle_logger.log_system_message("üóëÔ∏è –õ–æ–≥ –æ—á–∏—â–µ–Ω")
        # –ù–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∏–≥–Ω–∞–ª –ø–µ—Ä–µ—Ö–æ–¥–∞

    def exit_game(self) -> str:
        """–°–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤—ã–π—Ç–∏ –∏–∑ –∏–≥—Ä—ã."""
        battle_logger.log_system_message("üëã –î–æ –Ω–æ–≤—ã—Ö –≤—Å—Ç—Ä–µ—á!")
        return CMD_ACTION_EXIT

    # - –ú–µ—Ç–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –±–æ–ª—å—à–µ –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç –æ–∫–Ω–∞ -
    # –û–Ω–∏ —Ç–µ–ø–µ—Ä—å –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç —Å–∏–≥–Ω–∞–ª—ã
    def open_inventory(self) -> str:
        """–°–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç–∫—Ä—ã—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å."""
        # TODO: –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –æ—Ç–∫—Ä—ã—Ç–∏—é –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        return CMD_ACTION_OPEN_INVENTORY

    def open_skills(self) -> str:
        """–°–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç–∫—Ä—ã—Ç—å —É–º–µ–Ω–∏—è."""
        # TODO: –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –æ—Ç–∫—Ä—ã—Ç–∏—é —É–º–µ–Ω–∏–π, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        return CMD_ACTION_OPEN_SKILLS

    def open_shop(self) -> str:
        """–°–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω."""
        # TODO: –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –æ—Ç–∫—Ä—ã—Ç–∏—é –º–∞–≥–∞–∑–∏–Ω–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        battle_logger.log_system_message("üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω (–≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)")
        return CMD_ACTION_OPEN_SHOP # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∏–≥–Ω–∞–ª

    def open_statistics(self) -> str:
        """–°–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É."""
        # TODO: –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –ø–æ–∫–∞–∑—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        return CMD_ACTION_SHOW_STATS

    # - –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã (–æ—Å—Ç–∞–≤—à–∏–µ—Å—è –æ—Ç —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã) -
    def get_input(self) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É –≤–≤–æ–¥–∞ (–ø—É—Å—Ç–∞—è –¥–ª—è –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã)."""
        return ""

    def get_available_commands(self) -> List[str]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥."""
        # TODO: –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥
        return ['go', 'start', 'fight', 'help', 'h', 'clear', 'cls', 'exit', 'quit', 'q',
                'inventory', 'inv', 'i', 'skills', 'abilities', 'abil', 'stat']

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥ (–±—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ main)
# TODO: –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–∫–∞–∑–∞ –æ—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ command_handler
# –≤ –ø–æ–ª—å–∑—É –ª–æ–∫–∞–ª—å–Ω—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –≤ –∫–∞–∂–¥–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∏–ª–∏ –ø–µ—Ä–µ–¥–∞—á–∏ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç.
command_handler = None # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ None, –∑–∞—Ç–µ–º –≤ main.py
